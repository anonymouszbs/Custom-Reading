<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>Demo for Epub.js</title>
	<script src="js/jszip.min.js"></script>
	<script src="js/epub.min.js"></script>
	<link href="css/theme.css" />
	<link href="font/font.css" />
	<style>
		body {
			margin: 0;
			padding: 0;
			font-family: "serif", sans-serif;
		}

		.epub-container {
			margin: 0;
			padding: 0;
		}

		#pageNumId {
			z-index: 1000;
			position: fixed;
			float: right;
			bottom: 0;
			right: 0;
			padding-top: 20px;
			
			padding-right: 25px;
			padding-left: 25px;
			font-size: 15px;
			display: none;
		}
	</style>
</head>

<body>
	<p id="pageNumId">0/0</p>
	<div id="viewer"></div>
	<script>
		var pageNumId = document.getElementById("pageNumId");
		var $viewer = document.getElementById("viewer");
		var book = ePub();
		var currentContents, currentCfg;
		var width;
		var timer;
		function load(w, h) {
			//初始化赋值参数
			width = w;
			book.open("test.epub").then(function () {
				rendition = book.renderTo("viewer", {
					width: w,
					height: h, // 分页模式下 最好固定宽高
					flow: "paginated",
					axis: "horizontal",
					manager: "continuous",
					snap: true,
					spread: "none",//单页模式 none
				});

				book.loaded.navigation.then(function (toc) {
					window.flutter_inappwebview.callHandler("callChapter", toc);
				});
				book.ready.then(() => {
					//pageNumId.style.display = "block";
					///主题初始化及切换
					rendition.themes.register("观云", "css/theme.css");
					rendition.themes.register("榛子", "css/theme.css");
					rendition.themes.register("青云", "css/theme.css");
					rendition.themes.register("千草", "css/theme.css");
					rendition.themes.register("石竹", "css/theme.css");
					rendition.themes.register("铅色", "css/theme.css");
					rendition.themes.register("雷云", "css/theme.css");
					///选择主题
					rendition.themes.select("观云");
					///设置字体
					rendition.themes.fontSize('22px');
					///显示viewer
					rendition.display(0);
					///监听文本选择
					rendition.on("selected", buildBookSelected);
					//监听鼠标单击
					rendition.on('mouseup', function (selection) {
						window.flutter_inappwebview.callHandler("closeShowContextMenu", "");
					});
					///监听链接点击
					rendition.on('linkClicked', function (href) {
						return false;
					});
					///监听翻页
					rendition.on('relocated',function(location){
						///获取当前内容
						// const [a, b] = [rendition.currentLocation().start.cfi, rendition.currentLocation().end.cfi]
						// book.getRange(makeRangeCfi(a, b)).then(range => {
						//     alert(range.toString());
						// })
						pageNumId.innerHTML = location.end.displayed.page+"/"+location.end.displayed.total;
						clearInterval(timer);
						timer = setTimeout(() => {
							window.flutter_inappwebview.callHandler("chapterChange", location.end.href);
							clearInterval(timer);
						}, 1500);

					});
					///监听章节切换
					// rendition.on("locationChanged", function (location) {
					// 	clearInterval(timer);
					// 	timer = setTimeout(() => {
					// 		window.flutter_inappwebview.callHandler("chapterChange", location.href);
					// 		clearInterval(timer);
					// 	}, 1500);
					// });
					bookReady = true;
				});

			});

		}
		const makeRangeCfi = (a, b) => {
			    const CFI = new ePub.CFI()
			    const start = CFI.parse(a), end = CFI.parse(b)
			    const cfi = {
			        range: true,
			        base: start.base,
			        path: {
			            steps: [],
			            terminal: null
			        },
			        start: start.path,
			        end: end.path
			    }
			    const len = cfi.start.steps.length
			    for (let i = 0; i < len; i++) {
			        if (CFI.equalStep(cfi.start.steps[i], cfi.end.steps[i])) {
			            if (i == len - 1) {
			                // Last step is equal, check terminals
			                if (cfi.start.terminal === cfi.end.terminal) {
			                    // CFI's are equal
			                    cfi.path.steps.push(cfi.start.steps[i])
			                    // Not a range
			                    cfi.range = false
			                }
			            } else cfi.path.steps.push(cfi.start.steps[i])
			        } else break
			    }
			    cfi.start.steps = cfi.start.steps.slice(cfi.path.steps.length)
			    cfi.end.steps = cfi.end.steps.slice(cfi.path.steps.length)
			
			    return 'epubcfi(' + CFI.segmentString(cfi.base)
			        + '!' + CFI.segmentString(cfi.path)
			        + ',' + CFI.segmentString(cfi.start)
			        + ',' + CFI.segmentString(cfi.end)
			        + ')'
			}
		var isscroll = false;
		function 下一页(time) {
			if (isscroll) {
				return;
			}
			scrollBySecond(document.getElementsByClassName("epub-container")[0].clientWidth, time, "下一页");

		}
		function 上一页(time) {
			if (isscroll) {
				return;
			}
			scrollBySecond(document.getElementsByClassName("epub-container")[0].clientWidth, time, "上一页");

		}
		function scrollBySecond(distance, duration, type) {
			isscroll = true;
			const interval = 10; // 每隔 10ms 滚动一次
			var steps = duration / interval; // 计算总共需要滚动的次数
			const stepDistance = Math.floor(distance / steps); // 计算每次滚动的距离

			let currentStep = 0;

			if ((distance - (steps * stepDistance)) / stepDistance > 1) {
				steps = steps + Math.floor((distance - (steps * stepDistance)) / stepDistance);
			}
			const scrollInterval = setInterval(() => {

				if (type == "上一页") {
					document.getElementsByClassName("epub-container")[0].scrollBy(-stepDistance, 0);
				} else {
					document.getElementsByClassName("epub-container")[0].scrollBy(stepDistance, 0);
				}

				currentStep++;

				if (currentStep >= steps) {
					var movenum = distance - (stepDistance * currentStep);
					
					if (type == "上一页") {
						movenum = -movenum;
						
					}
					
					document.getElementsByClassName("epub-container")[0].scrollBy(movenum, 0);
					isscroll = false;
					clearInterval(scrollInterval);



				}
			}, interval);
		}

		function 划线(color) {
			
			rendition.annotations.highlight(currentCfg, {
				// 属性  例如 name:"name" -> data-name='name'
			}, function () {
				// 点击事件回调
			}, 'className', {
				// style
				'fill': color,
			});
		}


		var buildBookSelected = function (cfg, contents) {

			var text = contents.document.getSelection().toString(); // 获取所选文本
			var range = contents.window.getSelection().getRangeAt(0); // 获取所选文本范围
			currentContents = contents;//全局现行contents
			currentCfg = cfg;
			range = contents.range(cfg);
			const { x, y, width, height } = range.getBoundingClientRect();
			const cw = document.getElementById('viewer').clientWidth;

			var dx = x % cw + width / 2, dy = y + height / 2;
			window.flutter_inappwebview.callHandler("showContextMenu", dx + "|" + dy);

			//(y + height / 2) + "px"; // 转换为文档坐标系
			//(x % cw + width / 2) + "px"; // 转换为文档坐标系
		}

	// 监听选中文本事件

	</script>
</body>

</html>