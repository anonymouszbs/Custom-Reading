<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>Demo for Epub.js</title>
	<script src="js/jszip.min.js"></script>
	<script src="js/epub.min.js"></script>
	<link href="css/theme.css" />
	<link href="font/font.css" />
	<style>
		body {
			margin: 0;
			padding: 0;
			font-family: "serif", sans-serif;
		}

		.epub-container {
			margin: 0;
			padding: 0;
		}

		#pageNumId {
			z-index: 1000;
			position: fixed;
			float: right;
			bottom: 0;
			right: 0;
			padding-top: 20px;

			padding-right: 25px;
			padding-left: 25px;
			font-size: 15px;
			display: none;
		}
	</style>
</head>

<body>
	<p id="pageNumId">0/0</p>
	<div id="viewer"></div>
	<script>
		var pageNumId = document.getElementById("pageNumId");
		var $viewer = document.getElementById("viewer");
		var book;
		var currentContents, currentCfg,currentText;
		var width;
		var timer;

		function load(w, h, url, currentlocaiton) {
			//初始化赋值参数
			width = w;
			this.book = ePub(url);
			this.rendition = book.renderTo("viewer", {
				width: window.innerWidth,
				height: window.innerHeight, // 分页模式下 最好固定宽高

				flow: "paginated",
				axis: "horizontal",
				manager: "continuous",
				snap: true,
				spread: "none",//单页模式 none
			});
			//this.rendition.display(currentlocaiton);
			this.rendition.themes.register("观云", "css/theme.css");
			this.rendition.themes.register("榛子", "css/theme.css");
			this.rendition.themes.register("青云", "css/theme.css");
			this.rendition.themes.register("千草", "css/theme.css");
			this.rendition.themes.register("石竹", "css/theme.css");
			this.rendition.themes.register("铅色", "css/theme.css");
			this.rendition.themes.register("雷云", "css/theme.css");
			///选择主题
			this.rendition.themes.select("观云");
			///设置字体
			this.rendition.themes.fontSize('22px');
			this.themes = this.rendition.themes;
			book.loaded.navigation.then(function (toc) {
				if (currentlocaiton == 1) {
					rendition.display(toc[0].href)
				}
				window.flutter_inappwebview.callHandler("callChapter", toc);

			});
			book.ready.then(() => {
				///监听文本选择
				this.rendition.on("selected", buildBookSelected);
				//监听鼠标单击
				this.rendition.on('mouseup', function (selection) {
					window.flutter_inappwebview.callHandler("closeShowContextMenu", "");
				});
				///监听翻页
				rendition.on('relocated', function (location) {

					const [a, b] = [rendition.currentLocation().start.cfi, rendition.currentLocation().end.cfi]
					book.getRange(makeRangeCfi(a, b)).then(range => {
						window.flutter_inappwebview.callHandler("readtext", range.toString());

					});

					pageNumId.innerHTML = location.end.displayed.page + "/" + location.end
						.displayed.total;
					clearInterval(timer);
					var title = gettitle();
					title.href = location.end.href;
					监听进度();
					timer = setTimeout(() => {
						window.flutter_inappwebview.callHandler("chapterChange", title);
						clearInterval(timer);
					}, 1000);

				});


				return this.book.locations.generate(750 * (window.innerWidth / 375));
			}).then(result => {

				pageNumId.style.display = "block";//显示右下角标签
				this.locations = this.book.locations;
				window.flutter_inappwebview.callHandler("epubinit", true);
				//alert("加载完毕");
				//设置进度 直接跳转到指定位置 onProgressChange(60);
				//目录获取 vm.navigation = vm.book.navigation.toc;
				//bookReady = true;
			});



		}


		function onProgressChange(progress) {
			const percentage = progress / 100;
			const location = percentage > 0 ? this.locations.cfiFromPercentage(percentage) : 0;
			this.rendition.display(location);
		}
		///获取标题
		function gettitle() {

			if (rendition.getContents().length > 1) {

				var array = {
					id: rendition.getContents()[1].document.body.firstElementChild.id,
					title: rendition.getContents()[1].document.body.firstElementChild.textContent
				};
				return array;
			} else {
				var array = {
					id: rendition.getContents()[0].document.body.firstElementChild.id,
					title: rendition.getContents()[0].document.body.firstElementChild.textContent
				};
				return array;
			}
		}
		const makeRangeCfi = (a, b) => {
			const CFI = new ePub.CFI()
			const start = CFI.parse(a),
				end = CFI.parse(b)
			const cfi = {
				range: true,
				base: start.base,
				path: {
					steps: [],
					terminal: null
				},
				start: start.path,
				end: end.path
			}
			const len = cfi.start.steps.length
			for (let i = 0; i < len; i++) {
				if (CFI.equalStep(cfi.start.steps[i], cfi.end.steps[i])) {
					if (i == len - 1) {
						// Last step is equal, check terminals
						if (cfi.start.terminal === cfi.end.terminal) {
							// CFI's are equal
							cfi.path.steps.push(cfi.start.steps[i])
							// Not a range
							cfi.range = false
						}
					} else cfi.path.steps.push(cfi.start.steps[i])
				} else break
			}
			cfi.start.steps = cfi.start.steps.slice(cfi.path.steps.length)
			cfi.end.steps = cfi.end.steps.slice(cfi.path.steps.length)

			return 'epubcfi(' + CFI.segmentString(cfi.base) +
				'!' + CFI.segmentString(cfi.path) +
				',' + CFI.segmentString(cfi.start) +
				',' + CFI.segmentString(cfi.end) +
				')'
		}
		var isscroll = false;

		function 下一页(time) {

			if (isscroll) {
				return;
			}
			scrollBySecond(document.getElementsByClassName("epub-container")[0].clientWidth, time, "下一页");

		}

		function 监听进度() {
			var currentLocation = rendition.currentLocation();
			var progress = Math.floor(((locations.percentageFromCfi(currentLocation.start.cfi)).toFixed(6)) * 10000) / 100;

			window.flutter_inappwebview.callHandler("epubprogress", progress);
		}

		function 上一页(time) {
			if (isscroll) {
				return;
			}

			scrollBySecond(document.getElementsByClassName("epub-container")[0].clientWidth, time, "上一页");

		}

		function scrollBySecond(distance, duration, type) {
			isscroll = true;
			const interval = 10; // 每隔 10ms 滚动一次
			var steps = duration / interval; // 计算总共需要滚动的次数
			const stepDistance = Math.floor(distance / steps); // 计算每次滚动的距离

			let currentStep = 0;

			if ((distance - (steps * stepDistance)) / stepDistance > 1) {
				steps = steps + Math.floor((distance - (steps * stepDistance)) / stepDistance);
			}
			const scrollInterval = setInterval(() => {

				if (type == "上一页") {
					document.getElementsByClassName("epub-container")[0].scrollBy(-stepDistance, 0);
				} else {
					document.getElementsByClassName("epub-container")[0].scrollBy(stepDistance, 0);
				}

				currentStep++;

				if (currentStep >= steps) {
					var movenum = distance - (stepDistance * currentStep);

					if (type == "上一页") {
						movenum = -movenum;

					}

					document.getElementsByClassName("epub-container")[0].scrollBy(movenum, 0);
					isscroll = false;
					
					clearInterval(scrollInterval);



				}
			}, interval);
		}

		function onUnderline(cfg,color,txt,note){
			rendition.annotations.highlight(cfg, {
				// 属性  例如 name:"name" -> data-name='name'
				
			}, function () {
				// 点击事件回调
				window.flutter_inappwebview.callHandler("onUnderline", [cfg,color,txt,note]);
			}, 'className', {
				// style
				'fill': color,
			});
		}


		function 划线(color) {

			rendition.annotations.highlight(currentCfg, {
				// 属性  例如 name:"name" -> data-name='name'
				
			}, function () {
				// 点击事件回调
				
			}, 'className', {
				// style
				'fill': color,
			});
		}


		var buildBookSelected = function (cfg, contents) {

			var text = contents.document.getSelection().toString(); // 获取所选文本
			var range = contents.window.getSelection().getRangeAt(0); // 获取所选文本范围
			currentContents = contents; //全局现行contents
			currentCfg = cfg;
			currentText =  text;//所选文本
			range = contents.range(cfg);
			const {
				x,
				y,
				width,
				height
			} = range.getBoundingClientRect();
			const cw = document.getElementById('viewer').clientWidth;

			var dx = x % cw + width / 2,
				dy = y + height / 2;
			window.flutter_inappwebview.callHandler("showContextMenu", dx + "|" + dy);

			//(y + height / 2) + "px"; // 转换为文档坐标系
			//(x % cw + width / 2) + "px"; // 转换为文档坐标系
		}

			// 监听选中文本事件
	</script>
</body>

</html>